<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Funding Arbitrage Monitor</title>
  <link rel="icon" type="image/svg+xml" href="{{ url_for('static', path='/favicon.svg') }}?v={{ static_version }}">
  <link rel="stylesheet" href="{{ url_for('static', path='/styles.css') }}?v={{ static_version }}" />
  {% set raw_snapshot = state.get('snapshot') %}
  {% set snapshot = raw_snapshot or {} %}
  {% set has_snapshot = raw_snapshot is not none %}
  {% set screener_rows = snapshot.get('screener_rows', []) %}
  {% set coinglass_rows = snapshot.get('coinglass_rows', []) %}
  {% set universe_rows = snapshot.get('universe', []) %}
  {% set opportunity_rows = snapshot.get('opportunities', []) %}
  {% set messages = snapshot.get('messages', []) %}
  {% set status = state.get('status', 'idle') %}
  {% set status_class = status|lower|replace(' ', '-') %}
  {% set settings = state.get('settings', {}) %}
{% set refresh_interval = settings.get('table_refresh_seconds', state.get('refresh_interval', 300)) %}
{% set parser_interval = settings.get('parser_refresh_seconds', state.get('parser_refresh_interval', refresh_interval)) %}
{% set exchange_interval = settings.get('exchange_refresh_seconds', state.get('exchange_refresh_interval', parser_interval)) %}
{% set account_interval = settings.get('account_refresh_seconds', state.get('account_refresh_interval', 90)) %}
  {% set exchange_status_rows = state.get('exchange_status', []) %}
  {% set events = state.get('events', []) %}
  {% set last_event = events[-1] if events %}
  {% set accounts = state.get('accounts', {}) %}
  {% set account_status_rows = accounts.get('status', []) %}
  {% set account_balance_rows = accounts.get('balances', []) %}
  {% set symbol_position_rows = accounts.get('positions_by_symbol', []) %}
  {% set account_last_checked = accounts.get('last_updated') %}
  <script>
    window.__INITIAL_STATE__ = {{ state | tojson | safe }};
  </script>
  <script defer src="{{ url_for('static', path='/app.js') }}?v={{ static_version }}"></script>
</head>
<body class="page">
  <header class="masthead">
    <div>
      <h1>Funding Arbitrage Monitor</h1>
      <p class="subtitle">Live view of cross-exchange funding opportunities</p>
    </div>
    <div class="status-block">
      <dl>
        <div>
          <dt>Status</dt>
          <dd>
            <span id="status-pill" class="status-pill status-pill--{{ status_class }}">{{ status }}</span>
          </dd>
        </div>
        <div>
          <dt>Generated (UTC)</dt>
          <dd id="generated-at">{{ snapshot.get('generated_at') or "-" }}</dd>
        </div>
        <div>
          <dt>Last Updated</dt>
          <dd id="last-updated">{{ state.get('last_updated') or "-" }}</dd>
        </div>
        <div>
          <dt>Screener source</dt>
          <dd id="screener-source">
            {% if snapshot.get('screener_from_cache') is none %}
              -
            {% elif snapshot.get('screener_from_cache') %}
              cache
            {% else %}
              fresh
            {% endif %}
          </dd>
        </div>
        <div>
          <dt>Coinglass source</dt>
          <dd id="coinglass-source">
            {% if snapshot.get('coinglass_from_cache') is none %}
              -
            {% elif snapshot.get('coinglass_from_cache') %}
              cache
            {% else %}
              fresh
            {% endif %}
          </dd>
        </div>
        <div>
          <dt>Opportunities</dt>
          <dd id="opportunity-count">{{ opportunity_rows | length }}</dd>
        </div>
        <div>
          <dt>Last error</dt>
          {% set last_error = state.get('last_error') %}
          <dd id="last-error" title="{{ last_error or '' }}">{{ last_error or "None" }}</dd>
        </div>
        <div>
          <dt>Last progress</dt>
          <dd id="last-progress">
            {% if last_event %}
              {{ last_event.payload.message or last_event.event }}
            {% else %}
              -
            {% endif %}
          </dd>
        </div>
        <div>
          <dt>Exchange responses</dt>
          <dd id="exchange-summary">
            {% if exchange_status_rows %}
              {{ exchange_status_rows | length }} tracked
            {% else %}
              -
            {% endif %}
          </dd>
        </div>
      </dl>
      <button id="refresh-button" class="button" type="button">Manual refresh</button>
      <p class="hint">UI refresh: {{ refresh_interval }} s | Parser: {{ parser_interval }} s | Exchange poll: {{ exchange_interval }} s | Account refresh: {{ account_interval }} s</p>
    </div>
  </header>

  <main class="content">
    <section class="panel" id="settings-panel">
      <h2>Configuration</h2>
      <form id="settings-form">
        <fieldset class="settings-fieldset">
          <legend>Data sources</legend>
          <label class="settings-checkbox">
            <input type="checkbox" name="sources" value="arbitragescanner"{% if settings.get('sources', {}).get('arbitragescanner', True) %} checked{% endif %} />
            ArbitrageScanner
          </label>
          <label class="settings-checkbox">
            <input type="checkbox" name="sources" value="coinglass"{% if settings.get('sources', {}).get('coinglass', True) %} checked{% endif %} />
            Coinglass
          </label>
        </fieldset>
        <fieldset class="settings-fieldset">
          <legend>Exchanges</legend>
          <label class="settings-checkbox">
            <input type="checkbox" name="exchanges" value="bybit"{% if settings.get('exchanges', {}).get('bybit', True) %} checked{% endif %} />
            Bybit
          </label>
          <label class="settings-checkbox">
            <input type="checkbox" name="exchanges" value="mexc"{% if settings.get('exchanges', {}).get('mexc', True) %} checked{% endif %} />
            MEXC
          </label>
        </fieldset>
        <div class="settings-intervals">
          <label>
            Parser refresh (seconds)
            <input type="number" id="parser-interval" min="30" max="86400" step="1" value="{{ parser_interval }}" />
          </label>
          <label>
            Exchange poll (seconds)
            <input type="number" id="exchange-interval" min="30" max="86400" step="1" value="{{ exchange_interval }}" />
          </label>
          <label>
            UI refresh (seconds)
            <input type="number" id="table-interval" min="30" max="86400" step="1" value="{{ refresh_interval }}" />
          </label>
          <label>
            Account refresh (seconds)
            <input type="number" id="account-interval" min="30" max="86400" step="1" value="{{ account_interval }}" />
          </label>
        </div>
        <p class="settings-note muted">Keep at least one source and one exchange enabled.</p>
        <fieldset class="settings-fieldset">
          <legend>Protective orders</legend>
          <label class="settings-checkbox">
            <input type="checkbox" id="protect-auto" {% if settings.get('protective', {}).get('auto_protect_enabled', True) %}checked{% endif %} />
            Auto-place protective stops
          </label>
          <label class="settings-checkbox">
            <input type="checkbox" id="take-auto" {% if settings.get('protective', {}).get('auto_take_enabled', True) %}checked{% endif %} />
            Auto-place protective takes
          </label>
          <label class="settings-checkbox">
            <input type="checkbox" id="anti-orphan" {% if settings.get('protective', {}).get('anti_orphan_enabled', False) %}checked{% endif %} />
            Close paired leg on protective execution (anti-orphan)
          </label>
          <div class="settings-intervals">
            <label>
              Stop gap from liq (decimal)
              <input type="number" id="stop-gap" step="0.001" min="0" value="{{ settings.get('protective', {}).get('stop_gap_from_liq_pct', 0.07) }}" />
            </label>
            <label>
              Requote threshold (decimal)
              <input type="number" id="stop-requote" step="0.001" min="0" value="{{ settings.get('protective', {}).get('stop_requote_threshold_pct', 0.005) }}" />
            </label>
            <label>
              Fallback liq (long, multiplier)
              <input type="number" id="fallback-long" step="0.01" min="0" value="{{ settings.get('protective', {}).get('fallback_liq_factor_long', 0.33) }}" />
            </label>
            <label>
              Fallback liq (short, multiplier)
              <input type="number" id="fallback-short" step="0.01" min="0" value="{{ settings.get('protective', {}).get('fallback_liq_factor_short', 1.66) }}" />
            </label>
          </div>
        </fieldset>
        <div class="settings-actions">
          <button type="submit" class="button" id="settings-submit">Save settings</button>
          <span class="settings-status" id="settings-status" aria-live="polite"></span>
        </div>
      </form>
    </section>
    <section class="panel panel--muted" id="empty-state"{% if has_snapshot %} style="display: none;"{% endif %}>
        <h2>Preparing snapshot</h2>
        <p class="muted">
          We are collecting the latest market data. Tables will populate automatically once the snapshot is ready.
        </p>
      </section>

      <section class="panel panel--alert" id="messages"{% if not messages %} style="display: none;"{% endif %}>
        <h2>Status Messages</h2>
        <ul id="messages-list">
          {% for message in messages %}
            <li>{{ message }}</li>
          {% endfor %}
        </ul>
      </section>

    <section class="panel" id="exchange-status">
      <h2>Exchange Responses</h2>
      <table class="data-table" id="exchange-status-table">
        <thead>
          <tr>
            <th>Exchange</th>
            <th>Status</th>
            <th>Snapshots</th>
            <th>Message</th>
          </tr>
        </thead>
        <tbody id="exchange-status-body">
          {% for row in exchange_status_rows %}
            {% set status_slug = (row.status or 'unknown') | lower | replace(' ', '-') %}
            <tr>
              <td>{{ row.exchange }}</td>
              <td>
                <span class="status-chip status-chip--{{ status_slug }}">{{ row.status or "unknown" }}</span>
              </td>
              <td>{{ row.count if row.count is not none else "-" }}</td>
              <td>{{ row.message or row.error or "-" }}</td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </section>

    <section class="panel panel--compact" id="activity-log">
      <h2>Activity</h2>
      <ul class="event-log" id="event-log">
        {% for event in events %}
          <li class="event-log__item">
            <span class="event-log__time">{{ event.timestamp }}</span>
            <span class="event-log__message">
              {{ event.payload.message or event.event }}
            </span>
          </li>
        {% endfor %}
      </ul>
      <p class="muted" id="event-empty"{% if events %} style="display: none;"{% endif %}>
        Progress updates will appear here as the refresh runs.
      </p>
    </section>

    <section class="panel" id="overview">
      <h2>Data Overview</h2>
      <div class="overview-grid">
        <div>
          <h3>ArbitrageScanner Top Entries</h3>
          <table class="data-table" id="screener-table">
            <thead>
              <tr>
                <th>Symbol</th>
                <th>Spread %</th>
                <th>Long</th>
                <th>Long Fee %</th>
                <th>Short</th>
                <th>Short Fee %</th>
              </tr>
            </thead>
            <tbody>
              {% for row in screener_rows %}
                <tr>
                  <td>{{ row.symbol }}</td>
                  <td>{{ ((row.spread or 0) * 100) | round(4) }}</td>
                  <td>{{ row.long_exchange }}</td>
                  <td>{{ ((row.long_fee or 0) * 100) | round(4) }}</td>
                  <td>{{ row.short_exchange }}</td>
                  <td>{{ ((row.short_fee or 0) * 100) | round(4) }}</td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
        <div>
          <h3>Coinglass Top Entries</h3>
          <table class="data-table" id="coinglass-table">
            <thead>
              <tr>
                <th>Rank</th>
                <th>Symbol</th>
                <th>Pair</th>
                <th>Long</th>
                <th>Short</th>
                <th>Net %</th>
                <th>APR %</th>
                <th>Spread %</th>
              </tr>
            </thead>
            <tbody>
              {% for row in coinglass_rows %}
                <tr>
                  <td>{{ row.ranking }}</td>
                  <td>{{ row.symbol }}</td>
                  <td>{{ row.pair }}</td>
                  <td>{{ row.long_exchange }}</td>
                  <td>{{ row.short_exchange }}</td>
                  <td>{{ (row.net_funding_rate_percent or 0) | round(3) }}</td>
                  <td>{{ (row.apr_percent or 0) | round(2) }}</td>
                  <td>{{ (row.spread_rate_percent or 0) | round(3) }}</td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </section>

    <section class="panel" id="symbol-universe">
      <h2>Monitored Symbols</h2>
      <table class="data-table">
        <thead>
          <tr>
            <th>Symbol</th>
            <th>Sources</th>
          </tr>
        </thead>
        <tbody id="universe-table-body">
          {% for row in universe_rows %}
            <tr>
              <td>{{ row.symbol }}</td>
              <td>{{ row.sources }}</td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </section>

    <section class="panel" id="opportunities">
      <h2>Funding Opportunities</h2>
      <table class="data-table data-table--wide">
        <thead>
          <tr>
            <th>Symbol</th>
            <th>Long<br>Exchange</th>
            <th>Long<br>Rate&nbsp;%</th>
            <th>Long<br>Ask</th>
            <th>Long Liquidity<br>(USDT)</th>
            <th>Next Funding<br>(Long)</th>
            <th>Funding Interval<br>(Long, h)</th>
            <th>Short<br>Exchange</th>
            <th>Short<br>Rate&nbsp;%</th>
            <th>Short<br>Bid</th>
            <th>Short Liquidity<br>(USDT)</th>
            <th>Next Funding<br>(Short)</th>
            <th>Funding Interval<br>(Short, h)</th>
            <th>Spread&nbsp;%</th>
            <th>Price Gap&nbsp;%</th>
            <th>Effective<br>Spread&nbsp;%</th>
            <th>Participants</th>
          </tr>
        </thead>
        <tbody id="opportunity-table-body">
          {% for row in opportunity_rows %}
            <tr>
              <td>{{ row.symbol }}</td>
              <td>{{ row.long_exchange }}</td>
              <td>{{ ((row.long_rate or 0) * 100) | round(3) }}</td>
              <td>{{ row.long_ask if row.long_ask is not none else "-" }}</td>
              <td>{{ row.long_liquidity_usd if row.long_liquidity_usd is not none else "-" }}</td>
              <td>{{ row.long_next_funding or "-" }}</td>
              <td>{{ row.long_funding_interval_hours if row.long_funding_interval_hours is not none else "-" }}</td>
              <td>{{ row.short_exchange }}</td>
              <td>{{ ((row.short_rate or 0) * 100) | round(3) }}</td>
              <td>{{ row.short_bid if row.short_bid is not none else "-" }}</td>
              <td>{{ row.short_liquidity_usd if row.short_liquidity_usd is not none else "-" }}</td>
              <td>{{ row.short_next_funding or "-" }}</td>
              <td>{{ row.short_funding_interval_hours if row.short_funding_interval_hours is not none else "-" }}</td>
              <td>{{ ((row.spread or 0) * 100) | round(3) }}</td>
              <td>{{ ((row.price_diff_pct or 0) * 100) | round(3) }}</td>
              <td>{{ ((row.effective_spread or 0) * 100) | round(3) }}</td>
              <td>{{ row.participants }}</td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
      {% if opportunity_rows | length == 0 %}
        <p class="muted">No opportunities detected for the current snapshot.</p>
      {% endif %}
    </section>

    <section class="panel" id="account-status-panel">
      <h2>Exchange API Status</h2>
      <p class="muted">Last check: <span id="account-last-updated">{{ account_last_checked or "-" }}</span></p>
      <table class="data-table">
        <thead>
          <tr>
            <th>Exchange</th>
            <th>Status</th>
            <th>Message</th>
            <th>Checked</th>
          </tr>
        </thead>
        <tbody id="account-status-body">
          {% for row in account_status_rows %}
            <tr>
              <td>{{ row.exchange }}</td>
              <td>{{ row.status }}</td>
              <td>{{ row.message or row.error or "-" }}</td>
              <td>{{ row.checked_at or "-" }}</td>
            </tr>
          {% endfor %}
          {% if account_status_rows | length == 0 %}
            <tr><td colspan="4" class="muted">No credential checks have been run yet.</td></tr>
          {% endif %}
        </tbody>
      </table>
    </section>

    <section class="panel" id="perp-balances">
      <h2>Perpetual Account Balances</h2>
      <table class="data-table">
        <thead>
          <tr>
            <th>Exchange</th>
            <th>Asset</th>
            <th>Total</th>
            <th>Available</th>
            <th>In Use</th>
            <th>Margin Ratio</th>
            <th>Equity</th>
            <th>Buffer %</th>
            <th>Updated</th>
          </tr>
        </thead>
        <tbody id="account-balance-body">
          {% for row in account_balance_rows %}
            <tr>
                <td>{{ row.exchange }}</td>
                <td>{{ row.asset }}</td>
                <td>{{ row.total if row.total is not none else "-" }}</td>
                <td>{{ row.available if row.available is not none else "-" }}</td>
                <td>{{ row.used if row.used is not none else "-" }}</td>
                <td>
                {% if row.margin_ratio is number %}
                  {{ row.margin_ratio | round(4) }}
                {% else %}
                  -
                {% endif %}
                </td>
                <td>
                {% if row.equity is number %}
                  {{ row.equity | round(4) }}
                {% else %}
                  -
                {% endif %}
                </td>
                <td>
                {% if row.buffer_pct is number %}
                  {{ row.buffer_pct | round(2) }}%
                {% else %}
                  -
                {% endif %}
                </td>
                <td>{{ row.timestamp or "-" }}</td>
            </tr>
          {% endfor %}
          {% if account_balance_rows | length == 0 %}
            <tr><td colspan="9" class="muted">Balances will appear after the first refresh.</td></tr>
          {% endif %}
        </tbody>
      </table>
    </section>

    <section class="panel" id="symbol-positions-panel">
      <h2>Symbol Positions</h2>
      <table class="data-table data-table--wide">
        <thead>
          <tr>
            <th>Symbol</th>
            <th>Exchange</th>
            <th>Quantity</th>
            <th>Amount (USDT)</th>
            <th>Margin Used</th>
            <th>Entry</th>
            <th>Mark</th>
            <th>PnL</th>
            <th>Liq Price</th>
            <th>Liq Dist %</th>
            <th>Lev.</th>
            <th>Funding</th>
            <th>Exp. Funding</th>
            <th>Stop Price</th>
            <th>Take Price</th>
            <th>Next Funding</th>
          </tr>
        </thead>
                <tbody id="symbol-positions-body">
          {% for row in symbol_position_rows %}
            {% set tone = '' %}
            {% if row.type == 'summary' %}
              {% set pnl = row.unrealized_pnl %}
              {% set exp = row.expected_funding %}
              {% set pnl_sign = 1 if pnl is number and pnl > 0 else (-1 if pnl is number and pnl < 0 else 0) %}
              {% set exp_sign = 1 if exp is number and exp > 0 else (-1 if exp is number and exp < 0 else 0) %}
              {% if pnl_sign == 1 and exp_sign == 1 %}
                {% set tone = 'tone-pos' %}
              {% elif pnl_sign == -1 and exp_sign == -1 %}
                {% set tone = 'tone-neg' %}
              {% else %}
                {% set tone = 'tone-mixed' %}
              {% endif %}
            {% endif %}
            <tr class="{{ ('summary-row ' + tone) if row.type == 'summary' else '' }}" data-symbol="{{ row.symbol or '' }}">
              <td>{{ row.symbol }}</td>
              <td>{{ row.exchange or "-" }}</td>
              <td>{{ row.quantity }}</td>
              <td>{{ row.amount or "-" }}</td>
              <td>{{ row.margin_used if row.margin_used is not none else "-" }}</td>
              <td>{{ row.entry_price or "-" }}</td>
              <td>{{ row.mark_price or "-" }}</td>
              <td>{{ row.unrealized_pnl or "-" }}</td>
              <td>{{ row.liquidation_price if row.liquidation_price is not none else "-" }}</td>
              <td>
                {% if row.dist_to_liq_pct is defined and row.dist_to_liq_pct is not none %}
                  {{ row.dist_to_liq_pct | round(3) }}%
                {% else %}
                  -
                {% endif %}
              </td>
              <td>{{ row.leverage if row.leverage is not none else "-" }}</td>
              <td>
                {% if row.funding_rate is not none %}
                  {{ ((row.funding_rate or 0) * 100) | round(4) }}%
                {% else %}
                  -
                {% endif %}
              </td>
              <td>
                {% if row.expected_funding is defined and row.expected_funding is not none %}
                  {{ row.expected_funding | round(6) }}
                {% else %}
                  -
                {% endif %}
              </td>
              <td>
                {% if row.stop_price is defined and row.stop_price is not none %}
                  {{ row.stop_price | round(6) }}
                {% else %}
                  -
                {% endif %}
              </td>
              <td>
                {% if row.take_price is defined and row.take_price is not none %}
                  {{ row.take_price | round(6) }}
                {% else %}
                  -
                {% endif %}
              </td>
              <td>{{ row.next_funding_eta or row.next_funding or "-" }}</td>
            </tr>
          {% endfor %}
          {% if symbol_position_rows | length == 0 %}
            <tr><td colspan="16" class="muted">No live positions detected.</td></tr>
          {% endif %}
        </tbody>
      </table>
    </section>

    <section class="panel" id="reduction-candidates">
      <h2>Risk Reduction Candidates</h2>
      <table class="data-table data-table--wide">
        <thead>
          <tr>
            <th>Exchange</th>
            <th>Symbol</th>
            <th>Side</th>
            <th>Qty</th>
            <th>Suggested Close</th>
            <th>Paired Exchange</th>
            <th>Funding&nbsp;%</th>
            <th>Margin Ratio</th>
            <th>Reason</th>
          </tr>
        </thead>
        <tbody>
          {% for row in accounts.get('reduction_candidates', []) %}
            <tr>
              <td>{{ row.exchange }}</td>
              <td>{{ row.symbol }}</td>
              <td>{{ row.side }}</td>
              <td>{{ row.quantity }}</td>
              <td>{{ row.close_quantity }}</td>
              <td>{{ row.paired_exchange }}</td>
              <td>
                {% if row.funding_rate is not none %}
                  {{ (row.funding_rate * 100) | round(4) }}
                {% else %}
                  -
                {% endif %}
              </td>
              <td>{{ row.margin_ratio if row.margin_ratio is not none else "-" }}</td>
              <td>{{ row.reason }}</td>
            </tr>
          {% endfor %}
          {% if accounts.get('reduction_candidates', []) | length == 0 %}
            <tr><td colspan="9" class="muted">No candidates detected based on margin thresholds.</td></tr>
          {% endif %}
        </tbody>
      </table>
    </section>

    <section class="panel" id="execution-reservations">
      <h2>Active Reservations</h2>
      <table class="data-table">
        <thead>
          <tr>
            <th>Symbol</th>
            <th>Exchanges</th>
            <th>Notional</th>
            <th>Created</th>
            <th>Reservation</th>
          </tr>
        </thead>
        <tbody id="reservation-table-body"></tbody>
      </table>
    </section>

    <section class="panel" id="execution-activity-panel">
      <h2>Execution Activity</h2>
      <ul class="event-log" id="execution-activity"></ul>
    </section>
  </main>
</body>
</html>


